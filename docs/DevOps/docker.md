## Docker 与 容器化技术

微服务架构本质是一个分布式系统，分布式系统早于微服务架构之前就已经出现了。分布式系统的复杂性除了体现在开发时，对运维也提出了更高的要求，需要部署的应用数量从一个变成了几个甚至几十个。如果在运维方面没有相应的技术提升，微服务架构也不可能得到广泛的应用。

容器化技术的出现，为系统运维带来了新的可能性，微服务架构应用的部署离不开容器化技术。

下图为应用部署的发展阶段，从传统部署到硬件虚拟化，再到容器化。

![image](https://dyzzz.oss-cn-beijing.aliyuncs.com/img/docker01.png)

### 1.硬件虚拟化技术

在早期的时候，应用都是直接被安装在操作系统中的。在进行扩展时，我们需要在新的物理机器上安装操作系统，再安装应用，这种方式的问题在于**当多个应用共享物理资源时，一个应用可能占用过多的资源，从而影响其他应用的性能**。另外，这种方式进行**扩展的速度也很慢，需要从物理机器开始，无法快速响应业务的需求**。

硬件虚拟化技术的出现，为拓展提供了新的解决方案，硬件虚拟化指的是`对计算机虚拟化，虚拟化对用户隐藏了计算平台的物理特性，仅提供了一个抽象的计算平台`。

用来控制虚拟化的程序称为 Hypervisor，它可以创建和运行虚拟机。在虚拟机上我们可以安装不同类型的操作系统，包括 Windows、Linux 和 MacOS，虚拟机实例共享虚拟化的硬件资源。Hypervisor 通常分成两类：第一类 Hypervisor 直接在硬件上运行，如 Xen 和微软的 Hyper-V；第二类 Hypervisor 运行在已有的操作系统上，如 VMware Workstation、VMware Player、VirtualBox 和 QEMU。

硬件虚拟化使得我们可以更加充分地利用硬件资源，在创建集群时，可以用少数大型服务器替换掉数量较多的小型服务器。在这些服务器上运行 Hypervisor，并根据需要创建和运行虚拟机；在虚拟机上运行操作系统，而在操作系统上运行应用。

在创建虚拟机时我们可以限制虚拟机的 CPU、内存和硬盘等资源，硬件虚拟化可以更好的支持扩展。Hypervisor 可以从镜像文件中快速创建出虚拟机实例，当需要增加应用实例时，我们可以从保存的镜像中创建虚拟机并运行。**处理应用的失败也变得简单，只需要创建新的虚拟机实例替换掉出错的即可**。

### 2.容器化技术

硬件虚拟化的不足之处在于只能以操作系统为单位来进行扩展，操作系统本身也需要占用资源。当虚拟机的数量增加时，很多资源都被虚拟机中的操作系统占用。操作系统级别的虚拟化，也就是容器化，可以在隔离的容器中运行程序。容器中运行的程序只能访问操作系统的部分资源，包括CPU、内存、文件系统和网络等。目前最为流行的容器化实现是Docker，除此之外，还有 LXC 和 Container Linux 等实现。

随着Docker 的流行，容器化的实现也得到了广泛的应用。相对于基于 Hypervisor 的硬件虚拟化， 容器化有许多优势。

**2.1 传统部署流程的问题**

在早期的软件开发实践中，开发和运维团队的职责划分并不清晰。开发团队的成员在自己的本地环境上开发，通过持续集成环境构建出可部署的工件（Artifact），部署的工作由运维团队来完成。根据开发团队提供的文档，**在生产环境上安装应用及其依赖的外部服务，比如数据库和消息中间件等。**

这样的开发部署流程最大的问题在于，`无法保证开发时和运行时环境的一致性`。经常出现的问题是，应用在开发人员的开发环境上可以正常工作，到了生产环境中则会出现各种问题。有可能开发人员在本地环境上为应用添加了一个新的参数，但是忘了更新安装文档，导致运维团队安装的生产环境应用出现问题。

下图是传统的部署方式，可以看出，最大的问题在于手动维护安装文档，任何手动维护的文档从根本上来说都是不可信的，文档可能与代码失去同步。

![image](https://dyzzz.oss-cn-beijing.aliyuncs.com/img/docker02.png)